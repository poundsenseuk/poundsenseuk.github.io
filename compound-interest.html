<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PoundSenseUK – Compound Interest Calculator (UK)</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>Compound Interest Calculator (UK)</h1>
      <p class="sub">
        A practical “what happens to my money over time?” tool. Includes inflation (“today’s money”), contribution increases,
        and optional advanced events (lump sums, rate changes, pause/resume contributions).
      </p>

      <div class="pillrow">
        <span class="pill">Anonymous</span>
        <span class="pill">Client-side only</span>
        <span class="pill">Monthly timeline simulation</span>
      </div>

      <div class="pillrow">
        <a href="https://poundsenseuk.github.io"><span class="pill">Go To Home</span></a>
      </div>
    </header>

    <!-- INPUTS -->
    <div class="card">
      <h2>Inputs</h2>
      <div id="msg" class="alert warn" style="display:none;"></div>

      <!-- Core inputs (always visible) -->
      <div class="formgrid">
        <div class="field">
          <label for="startBalance">Starting balance (£)</label>
          <input id="startBalance" type="number" min="0" step="100" value="5000" />
          <p class="help">Your starting pot.</p>
        </div>

        <div class="field">
          <label for="startDate">Start date</label>
          <input id="startDate" type="date" />
          <p class="help">Defaults to today.</p>
        </div>

        <div class="field">
          <label for="years">Time period (years)</label>
          <input id="years" type="number" min="0" step="1" value="20" />
        </div>

        <div class="field">
          <label for="months">Extra months</label>
          <input id="months" type="number" min="0" max="11" step="1" value="0" />
          <p class="help">Add months beyond whole years (0–11).</p>
        </div>

        <div class="field">
          <label for="rateApr">Interest rate (APR %, nominal)</label>
          <input id="rateApr" type="number" min="0" step="0.01" value="7.00" />
          <p class="help">Nominal return (before inflation). Advanced events can change this over time.</p>
        </div>

        <div class="field">
          <label for="compoundFreq">Compounding frequency</label>
          <select id="compoundFreq">
            <option value="monthly" selected>Monthly</option>
            <option value="daily">Daily (approx)</option>
            <option value="annual">Annual</option>
          </select>
          <p class="help">How interest is applied. (Most “normal” calculators assume monthly.)</p>
        </div>

        <div class="field">
          <label for="inflation">Inflation (annual %, optional)</label>
          <input id="inflation" type="number" min="0" step="0.01" value="2.50" />
          <p class="help">
            Used to show “today’s money” values. Example: 3% inflation means £100 in the future buys ~£97 worth of stuff in today’s terms.
          </p>
        </div>

        <div class="field">
          <label for="safeWR">Withdrawal rate (%, for income estimate)</label>
          <input id="safeWR" type="number" min="0" step="0.1" value="4.0" />
          <p class="help">Used for the “monthly income at end” estimate (e.g., 4% rule).</p>
        </div>
      </div>

      <div class="hr"></div>

      <!-- Contributions (always visible; advanced mode uses these as baseline) -->
      <h2 style="margin-top:0;">Ongoing contributions</h2>

      <div class="formgrid">
        <div class="field">
          <label for="contribAmount">Contribution amount (£)</label>
          <input id="contribAmount" type="number" min="0" step="10" value="200" />
          <p class="help">Your regular contribution.</p>
        </div>

        <div class="field">
          <label for="contribFreq">Contribution frequency</label>
          <select id="contribFreq">
            <option value="monthly" selected>Monthly</option>
            <option value="weekly">Weekly</option>
            <option value="daily">Daily</option>
            <option value="yearly">Yearly</option>
          </select>
          <p class="help">Converted into an equivalent monthly amount for the timeline.</p>
        </div>

        <div class="field">
          <label for="annualIncrease">Yearly contribution increase (%)</label>
          <input id="annualIncrease" type="number" min="0" step="0.1" value="0" />
          <p class="help">
            If &gt; 0, your contribution amount increases each year by this %. (No checkbox needed.)
          </p>
        </div>

        <div class="field">
          <label class="check" style="margin-top:22px;">
            <input id="contribPaused" type="checkbox" />
            Start with contributions paused
          </label>
          <p class="help">Useful if you want to model “I’ll start later” without adding an event.</p>
        </div>
      </div>

      <div class="hr"></div>

      <!-- Advanced: events (DOES NOT HIDE SIMPLE) -->
      <div class="callouts callouts--single" style="margin-top:10px;">
        <div class="callout">
          <div class="tag info">Advanced mode (optional)</div>
          <p class="small muted" style="margin:0;">
            Use events for changes over time: lump sums, withdrawals, rate changes, contribution changes, pause/resume.
            If you don’t add events, this behaves like a normal compound interest calculator.
          </p>
        </div>
      </div>

      <h2 style="margin-top:14px;">Events</h2>

      <div class="formgrid">
        <div class="field">
          <label for="eventType">Event type</label>
          <select id="eventType">
            <option value="oneoff_cash" selected>One-off deposit / withdrawal</option>
            <option value="set_monthly_contrib">Set monthly contribution from date</option>
            <option value="monthly_contrib_delta">Change monthly contribution (delta) from date</option>
            <option value="rate_change">Change interest rate (APR) from date</option>
            <option value="pause_contrib">Pause contributions (for N months)</option>
            <option value="resume_contrib">Resume contributions</option>
          </select>
          <p class="help">Pick what changes at that date.</p>
        </div>

        <div class="field">
          <label for="eventDate">Event date</label>
          <input id="eventDate" type="date" />
          <p class="help">Applied at the start of the month containing this date.</p>
        </div>

        <div class="field">
          <label for="eventValue">Value (£ / % / months)</label>
          <input id="eventValue" type="number" step="0.01" value="1000" />
          <p class="help" id="eventHelp"></p>
        </div>

        <div class="field">
          <label class="check" style="margin-top:22px;">
            <input id="eventOngoing" type="checkbox" checked />
            Ongoing change (where relevant)
          </label>
          <p class="help">Some event types are always one-off (e.g., cash deposit). Others persist by definition.</p>
        </div>
      </div>

      <div class="inline" style="margin-top:12px;">
        <a class="btn secondary" href="#" id="addEventBtn">Add event</a>
        <a class="btn" href="#" id="clearEventsBtn">Clear events</a>
      </div>

      <div class="tablewrap" style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th>End of year</th>
              <th>Nominal balance</th>
              <th>Interest earned</th>
              <th>Contributed (year)</th>
              <th>Total contributed</th>
              <th>Balance (today’s money)</th>
            </tr>
          </thead>
          <tbody id="eventsTbody">
            <tr><td colspan="5" class="muted">No events yet.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="hr"></div>

      <div class="inline" style="margin-top:12px;">
        <a class="btn" href="#" id="calcBtn">Calculate</a>
        <a class="btn secondary" href="#" id="resetBtn">Reset</a>
      </div>

      <p class="note" style="margin-top:14px;">
        <b>Disclaimer:</b> Not financial advice. This is an educational estimate. Real returns and inflation vary, taxes matter,
        and markets don’t move smoothly.
      </p>
    </div>

    <!-- RESULTS -->
    <div class="card" id="results" style="margin-top:14px; display:none;">
      <h2>Results</h2>

      <div class="callouts callouts--single" style="margin-top:10px;">
        <div class="callout">
          <div class="tag best">What “today’s money” means</div>
          <p class="small muted" style="margin:0;">
            <b>Nominal</b> = future pounds (the number you’d see on your account).<br/>
            <b>Today’s money</b> = inflation-adjusted purchasing power (what that future pot is roughly “worth” in today’s terms).<br/>
            If inflation is 0%, nominal and today’s money will match.
          </p>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="label">Final value (nominal)</div>
          <div class="value" id="finalNominal">—</div>
        </div>
        <div class="kpi">
          <div class="label">Final value (today’s money)</div>
          <div class="value" id="finalReal">—</div>
        </div>
        <div class="kpi">
          <div class="label">Projection end date</div>
          <div class="value" id="endDateKpi">—</div>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="label">Total contributed (nominal)</div>
          <div class="value" id="totalContribNom">—</div>
          <p class="help">Sum of all deposits minus withdrawals (in cash terms).</p>
        </div>
        <div class="kpi">
          <div class="label">Total contributed (today’s money)</div>
          <div class="value" id="totalContribReal">—</div>
          <p class="help">Your contributions expressed in today’s purchasing power.</p>
        </div>
        <div class="kpi">
          <div class="label">Total interest earned (nominal)</div>
          <div class="value" id="totalInterest">—</div>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="label">Monthly income at end (nominal)</div>
          <div class="value" id="incomeNom">—</div>
          <p class="help">Uses your withdrawal rate (e.g., 4%) divided by 12.</p>
        </div>
        <div class="kpi">
          <div class="label">Monthly income at end (today’s money)</div>
          <div class="value" id="incomeReal">—</div>
        </div>
        <div class="kpi">
          <div class="label">Net gain (today’s money)</div>
          <div class="value" id="netGainReal">—</div>
          <p class="help">Final today’s-money value minus today’s-money contributions.</p>
        </div>
      </div>

      <div class="callouts" style="margin-top:12px;">
        <div class="callout">
          <div class="tag info">Chart view</div>
          <div class="inline" style="margin-top:8px;">
            <select id="chartView" style="padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(11,15,20,.55);color:var(--text);">
              <option value="both" selected>Nominal + Today’s money</option>
              <option value="nominal">Nominal only</option>
              <option value="real">Today’s money only</option>
            </select>
            <label class="check">
              <input id="showContribLine" type="checkbox" checked />
              Show contributions line
            </label>
          </div>
        </div>

        <div class="callout">
          <div class="tag caution">Reality check</div>
          <p class="small muted" style="margin:0;">
            This is a smooth projection. Real markets vary year-to-year. A future upgrade could add a range view (e.g., 4% / 7% / 10%).
          </p>
        </div>
      </div>

      <div class="chartwrap">
        <canvas id="chart"></canvas>
      </div>

      <div class="hr"></div>

      <h2 style="margin-top:0;">Snapshot (selected years)</h2>
      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th>Year</th>
              <th>Nominal balance</th>
              <th>Today’s money</th>
              <th>Total contributed</th>
              <th>Interest earned</th>
            </tr>
          </thead>
          <tbody id="snapTbody">
            <tr><td colspan="5" class="muted">Calculate to see snapshot.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <footer>
      <p class="disclosure">Affiliate disclosure: Some outbound links may be affiliate links at no extra cost to you.</p>
      <p class="note">© PoundSenseUK — calculators are estimates, not advice.</p>
    </footer>
  </div>

  <script>
    // ---------------- helpers ----------------
    const GBP = (x) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(x);
    const msg = document.getElementById('msg');

    function showMsg(text, kind='warn'){
      msg.className = `alert ${kind}`;
      msg.textContent = text;
      msg.style.display = 'block';
    }
    function hideMsg(){ msg.style.display = 'none'; }

    function round2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }

    function monthsTotal(y, m){
      y = Number.isFinite(y) ? y : 0;
      m = Number.isFinite(m) ? m : 0;
      return Math.max(0, Math.floor(y) * 12 + Math.floor(m));
    }

    function toDateInputValue(d){
      const pad = (n) => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function parseDateOr(dStr, fallback){
      const d = dStr ? new Date(dStr + "T00:00:00") : null;
      return (d && !isNaN(d.getTime())) ? d : fallback;
    }

    function addMonths(date, n){
      const d = new Date(date);
      const day = d.getDate();
      d.setMonth(d.getMonth() + n);
      const last = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
      d.setDate(Math.min(day, last));
      return d;
    }

    function monthKey(d){
      const mm = String(d.getMonth()+1).padStart(2,'0');
      return `${d.getFullYear()}-${mm}`;
    }

    function daysInMonth(d){
      return new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
    }

    function annualToMonthlyInflation(inflPct){
      const inf = Math.max(0, inflPct) / 100;
      return (inf <= 0) ? 0 : (Math.pow(1 + inf, 1/12) - 1);
    }

    function freqToMonthly(amount, freq){
      amount = Number(amount) || 0;
      switch(freq){
        case 'daily':  return amount * (365.2425 / 12);
        case 'weekly': return amount * (52.1775 / 12);
        case 'yearly': return amount / 12;
        case 'monthly':
        default:       return amount;
      }
    }

    // Interest application per month, depending on compounding mode
    function interestForMonth(balance, aprPct, compoundFreq, monthStartDate){
      const apr = Math.max(0, aprPct) / 100;
      if (apr <= 0) return 0;

      if (compoundFreq === 'monthly'){
        const mRate = Math.pow(1 + apr, 1/12) - 1;
        return balance * mRate;
      }

      if (compoundFreq === 'daily'){
        const daily = apr / 365;
        const d = daysInMonth(monthStartDate);
        const mRate = Math.pow(1 + daily, d) - 1;
        return balance * mRate;
      }

      // annual: apply only on “anniversary months” (every 12 months)
      // This is a simplification but very readable for users.
      if (compoundFreq === 'annual'){
        const isAnniversary = (monthStartDate.getMonth() === parseDateOr(document.getElementById('startDate').value, new Date()).getMonth());
        // Apply once per year on that month:
        return isAnniversary ? (balance * apr) : 0;
      }

      // default fallback
      const mRate = Math.pow(1 + apr, 1/12) - 1;
      return balance * mRate;
    }

    // ---------------- events ----------------
    let events = []; // {id, dateStr, type, value}

    function eventLabel(type){
      switch(type){
        case 'oneoff_cash': return 'One-off cash';
        case 'set_monthly_contrib': return 'Set monthly contrib';
        case 'monthly_contrib_delta': return 'Monthly contrib change';
        case 'rate_change': return 'Rate change';
        case 'pause_contrib': return 'Pause contrib';
        case 'resume_contrib': return 'Resume contrib';
        default: return type;
      }
    }

    function eventValueDisplay(ev){
      const v = Number(ev.value) || 0;
      if (ev.type === 'rate_change') return `${v.toFixed(2)}%`;
      if (ev.type === 'pause_contrib') return `${Math.max(0, Math.floor(v))} months`;
      if (ev.type === 'resume_contrib') return '—';
      return GBP(v);
    }

    function eventEffectText(ev){
      const v = Number(ev.value) || 0;
      switch(ev.type){
        case 'oneoff_cash': return v >= 0 ? 'Adds lump sum' : 'Withdraws lump sum';
        case 'set_monthly_contrib': return 'Sets ongoing monthly contribution';
        case 'monthly_contrib_delta': return v >= 0 ? 'Increases monthly contribution' : 'Decreases monthly contribution';
        case 'rate_change': return 'Sets new APR from date';
        case 'pause_contrib': return 'Pauses contributions temporarily';
        case 'resume_contrib': return 'Resumes contributions';
        default: return '';
      }
    }

    function helpForEventType(t){
      const el = document.getElementById('eventHelp');
      const ongoing = document.getElementById('eventOngoing');

      if (t === 'oneoff_cash'){
        el.textContent = 'Enter +£ for a deposit or -£ for a withdrawal (one-off).';
        ongoing.checked = false;
        ongoing.disabled = true;
      } else if (t === 'set_monthly_contrib'){
        el.textContent = 'Enter the new monthly contribution amount from this date onward (e.g., 350 = £350/month).';
        ongoing.checked = true;
        ongoing.disabled = true;
      } else if (t === 'monthly_contrib_delta'){
        el.textContent = 'Enter the monthly change from this date onward (e.g., +50 = +£50/month, -25 = -£25/month).';
        ongoing.checked = true;
        ongoing.disabled = true;
      } else if (t === 'rate_change'){
        el.textContent = 'Enter the new APR (%) from this date onward (e.g., 5.5).';
        ongoing.checked = true;
        ongoing.disabled = true;
      } else if (t === 'pause_contrib'){
        el.textContent = 'Enter how many months to pause contributions for (e.g., 6).';
        ongoing.checked = false;
        ongoing.disabled = true;
      } else if (t === 'resume_contrib'){
        el.textContent = 'No value needed. Contributions resume from this month.';
        ongoing.checked = false;
        ongoing.disabled = true;
      } else {
        el.textContent = '';
        ongoing.disabled = false;
      }
    }

    function renderEventsTable(){
      const tb = document.getElementById('eventsTbody');
      if (!events.length){
        tb.innerHTML = `<tr><td colspan="5" class="muted">No events yet.</td></tr>`;
        return;
      }

      const rows = events
        .slice()
        .sort((a,b) => a.dateStr.localeCompare(b.dateStr))
        .map(ev => `
          <tr>
            <td>${ev.dateStr}</td>
            <td>${eventLabel(ev.type)}</td>
            <td>${eventValueDisplay(ev)}</td>
            <td class="muted">${eventEffectText(ev)}</td>
            <td><a href="#" class="btn secondary" data-del="${ev.id}" style="padding:6px 10px; border-radius:10px;">Remove</a></td>
          </tr>
        `).join('');

      tb.innerHTML = rows;
      tb.querySelectorAll('[data-del]').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const id = a.getAttribute('data-del');
          events = events.filter(x => x.id !== id);
          renderEventsTable();
        });
      });
    }

    function bucketEventsByMonth(startDate, months){
      const map = new Map();
      const end = addMonths(startDate, months);

      for (const ev of events){
        const d = parseDateOr(ev.dateStr, null);
        if (!d) continue;
        if (d < startDate || d >= end) continue;
        const k = monthKey(d);
        if (!map.has(k)) map.set(k, []);
        map.get(k).push(ev);
      }
      return map;
    }

    // ---------------- chart ----------------
    let chart;

    function monthLabelsMMYY(startDate, nMonths){
      const labels = [];
      let d = new Date(startDate);
      for (let i = 0; i < nMonths; i++){
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const yy = String(d.getFullYear()).slice(-2);
        labels.push(`${mm}/${yy}`);
        d = addMonths(d, 1);
      }
      return labels;
    }

    function renderChart(labels, nominal, real, contribNom, view, showContrib){
      const ctx = document.getElementById('chart');
      if (chart) chart.destroy();

      const dsNom = { label: 'Balance (nominal £)', data: nominal, tension: 0.25, hidden: (view === 'real') };
      const dsReal = { label: 'Balance (today’s money £)', data: real, tension: 0.25, hidden: (view === 'nominal') };
      const dsCon = { label: 'Total in (starting + contributions) (£)', data: contribNom, tension: 0.15, hidden: !showContrib };

      chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [dsNom, dsReal, dsCon] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { labels: { color: '#93a4b8' } },
            tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${GBP(c.raw ?? 0)}` } }
          },
          scales: {
            x: { ticks: { color: '#93a4b8', maxTicksLimit: 12 }, grid: { color: 'rgba(34,48,71,.35)' } },
            y: {
              beginAtZero: true,
              ticks: { color: '#93a4b8', maxTicksLimit: 8, callback: (v) => GBP(v) },
              grid: { color: 'rgba(34,48,71,.35)' }
            }
          }
        }
      });
    }

    // ---------------- simulation ----------------
    function simulate({
      startBalance,
      startDate,
      months,
      aprPct,
      inflationPct,
      compoundFreq,
      baseContribAmount,
      baseContribFreq,
      annualIncreasePct,
      startPaused
    }){
      let balance = Math.max(0, Number(startBalance) || 0);

      // Baseline monthly contrib derived from freq
      let monthlyContrib = freqToMonthly(baseContribAmount, baseContribFreq);
      const inc = Math.max(0, Number(annualIncreasePct) || 0) / 100;

      const mInfl = annualToMonthlyInflation(inflationPct);

      // Events bucketed by month
      const eventsByMonth = bucketEventsByMonth(startDate, months);

      // Contribution pause handling
      let paused = !!startPaused;
      let pauseRemainingMonths = 0;

      // Current running parameters (that events can change)
      let currentApr = Math.max(0, Number(aprPct) || 0);
      let currentMonthlyContrib = Math.max(0, monthlyContrib);

      // Totals (nominal cash)
      let totalContribNom = 0;
      let totalInterestNom = 0;

      // Totals in today's money (deflated as we go)
      let totalContribReal = 0;

      // Series
      const seriesNom = [];
      const seriesReal = [];
      const seriesContribNom = [];

      let cumContribNom = balance;          // start contributed line at starting balance
      let inflFactor = 1;
      
      // optional: treat starting balance as "already contributed" in totals too
      totalContribNom += balance;
      totalContribReal += balance;          // at t=0 inflation factor = 1


      for (let i = 0; i < months; i++){
        const monthStart = addMonths(startDate, i);
        const k = monthKey(monthStart);

        // Apply yearly contribution increase (baseline behaviour) at year boundaries
        // This affects currentMonthlyContrib *unless an event explicitly sets it* later.
        if (i > 0 && i % 12 === 0 && inc > 0){
          // Only apply to baseline; if events have set a new monthly amount, users usually still expect the raise on that amount.
          currentMonthlyContrib = currentMonthlyContrib * (1 + inc);
        }

        // Apply events at start of month
        const evs = (eventsByMonth.get(k) || []).slice().sort((a,b)=>a.type.localeCompare(b.type));
        for (const ev of evs){
          const val = Number(ev.value) || 0;

          if (ev.type === 'oneoff_cash'){
            balance += val;
            totalContribNom += val;
            cumContribNom += val;

            // deflate this cash flow into today's money using current inflation factor AFTER update below?
            // We treat it as happening at month start, so use current inflFactor.
            totalContribReal += (inflFactor > 0) ? (val / inflFactor) : val;
          }

          if (ev.type === 'set_monthly_contrib'){
            currentMonthlyContrib = Math.max(0, val);
          }

          if (ev.type === 'monthly_contrib_delta'){
            currentMonthlyContrib = Math.max(0, currentMonthlyContrib + val);
          }

          if (ev.type === 'rate_change'){
            currentApr = Math.max(0, val);
          }

          if (ev.type === 'pause_contrib'){
            pauseRemainingMonths = Math.max(0, Math.floor(val));
            paused = pauseRemainingMonths > 0;
          }

          if (ev.type === 'resume_contrib'){
            paused = false;
            pauseRemainingMonths = 0;
          }
        }

        // Contribution for this month (if not paused)
        let contribThisMonth = 0;
        if (!paused){
          contribThisMonth = Math.max(0, currentMonthlyContrib);
          balance += contribThisMonth;
          totalContribNom += contribThisMonth;
          cumContribNom += contribThisMonth;

          totalContribReal += (inflFactor > 0) ? (contribThisMonth / inflFactor) : contribThisMonth;
        }

        // Interest
        const interest = interestForMonth(balance, currentApr, compoundFreq, monthStart);
        balance += interest;
        totalInterestNom += interest;

        // Update inflation factor at end of month (for end-of-month value comparison)
        inflFactor *= (1 + mInfl);
        const realVal = (inflFactor > 0) ? (balance / inflFactor) : balance;

        // Decrement pause timer after processing month
        if (paused && pauseRemainingMonths > 0){
          pauseRemainingMonths -= 1;
          if (pauseRemainingMonths <= 0){
            paused = false;
          }
        }

        seriesNom.push(round2(balance));
        seriesReal.push(round2(realVal));
        seriesContribNom.push(round2(cumContribNom));
      }

      const endDate = addMonths(startDate, months);

      return {
        finalNominal: round2(balance),
        finalReal: round2(seriesReal[seriesReal.length - 1] ?? 0),
        totalContribNom: round2(totalContribNom),
        totalContribReal: round2(totalContribReal),
        totalInterestNom: round2(totalInterestNom),
        seriesNom, seriesReal, seriesContribNom,
        endDate
      };
    }

    // ---------------- snapshot table ----------------
    function renderSnapshot(startDate, result){
        const tb = document.getElementById('snapTbody');
      
        const monthsLen = result.seriesNom.length;
        if (monthsLen <= 0){
          tb.innerHTML = `<tr><td colspan="6" class="muted">No data.</td></tr>`;
          return;
        }
      
        // We assume seriesContribNom is cumulative "total paid in" (including starting balance if you baseline it)
        // Yearly contributed = change in seriesContribNom over that year (excluding any starting balance already baked in)
        const rows = [];
        const nYears = Math.ceil(monthsLen / 12);
      
        let prevTotalContrib = 0;
      
        for (let y = 1; y <= nYears; y++){
          const idx = Math.min(y * 12 - 1, monthsLen - 1); // end of year or end of projection
      
          const nomBal = result.seriesNom[idx] ?? 0;
          const realBal = result.seriesReal[idx] ?? 0;
      
          const totalContrib = result.seriesContribNom[idx] ?? 0; // cumulative paid in (baseline + flows)
          const contributedYear = totalContrib - prevTotalContrib;
      
          const interestEarned = nomBal - totalContrib; // since balance = contributions + interest (with withdrawals already netted into totalContrib)
      
          rows.push(`
            <tr>
              <td>Year ${y}</td>
              <td>${GBP(nomBal)}</td>
              <td>${GBP(round2(interestEarned))}</td>
              <td>${GBP(round2(contributedYear))}</td>
              <td>${GBP(round2(totalContrib))}</td>
              <td>${GBP(realBal)}</td>
            </tr>
          `);
      
          prevTotalContrib = totalContrib;
        }
      
        tb.innerHTML = rows.join('');
      }

      if (!rows.length){
        tb.innerHTML = `<tr><td colspan="5" class="muted">Projection too short for snapshot years.</td></tr>`;
      } else {
        tb.innerHTML = rows.join('');
      }
    }

    // ---------------- validation + UI ----------------
    function validate(){
      const startBalance = Number(document.getElementById('startBalance').value);
      if (!(startBalance >= 0)) return 'Starting balance must be 0 or more.';

      const totalM = monthsTotal(Number(document.getElementById('years').value), Number(document.getElementById('months').value));
      if (!(totalM > 0)) return 'Time period must be at least 1 month.';

      const apr = Number(document.getElementById('rateApr').value);
      if (!(apr >= 0)) return 'Interest rate cannot be negative.';

      const infl = Number(document.getElementById('inflation').value);
      if (!(infl >= 0)) return 'Inflation cannot be negative.';

      const safeWR = Number(document.getElementById('safeWR').value);
      if (!(safeWR >= 0)) return 'Withdrawal rate cannot be negative.';

      // validate event dates
      for (const ev of events){
        const d = parseDateOr(ev.dateStr, null);
        if (!d) return 'One of your event dates is invalid.';
        if (ev.type === 'rate_change' && (Number(ev.value) || 0) < 0) return 'Event rate cannot be negative.';
        if (ev.type === 'pause_contrib' && (Number(ev.value) || 0) < 0) return 'Pause months cannot be negative.';
      }

      return null;
    }

    function calculate(e){
      e.preventDefault();
      hideMsg();

      const err = validate();
      if (err){ showMsg(err, 'bad'); return; }

      const startBalance = Number(document.getElementById('startBalance').value) || 0;
      const startDate = parseDateOr(document.getElementById('startDate').value, new Date());

      const totalM = monthsTotal(Number(document.getElementById('years').value), Number(document.getElementById('months').value));
      const apr = Number(document.getElementById('rateApr').value) || 0;
      const infl = Number(document.getElementById('inflation').value) || 0;

      const compoundFreq = document.getElementById('compoundFreq').value;
      const contribAmount = Number(document.getElementById('contribAmount').value) || 0;
      const contribFreq = document.getElementById('contribFreq').value;

      const annualIncrease = Number(document.getElementById('annualIncrease').value) || 0;
      const paused = document.getElementById('contribPaused').checked;

      const safeWR = Number(document.getElementById('safeWR').value) || 0;
      const wr = safeWR / 100;

      const result = simulate({
        startBalance,
        startDate,
        months: totalM,
        aprPct: apr,
        inflationPct: infl,
        compoundFreq,
        baseContribAmount: contribAmount,
        baseContribFreq: contribFreq,
        annualIncreasePct: annualIncrease,
        startPaused: paused
      });

      // KPIs
      document.getElementById('finalNominal').textContent = GBP(result.finalNominal);
      document.getElementById('finalReal').textContent = GBP(result.finalReal);
      document.getElementById('endDateKpi').textContent = result.endDate.toLocaleDateString('en-GB', { year:'numeric', month:'short' });

      document.getElementById('totalContribNom').textContent = GBP(result.totalContribNom);
      document.getElementById('totalContribReal').textContent = GBP(result.totalContribReal);
      document.getElementById('totalInterest').textContent = GBP(result.totalInterestNom);

      const incomeNom = (wr > 0) ? (result.finalNominal * wr / 12) : 0;
      const incomeReal = (wr > 0) ? (result.finalReal * wr / 12) : 0;
      document.getElementById('incomeNom').textContent = GBP(round2(incomeNom));
      document.getElementById('incomeReal').textContent = GBP(round2(incomeReal));

      const netGainReal = round2(result.finalReal - result.totalContribReal);
      document.getElementById('netGainReal').textContent = GBP(netGainReal);

      // Chart
      const labels = monthLabelsMMYY(startDate, totalM);
      const view = document.getElementById('chartView').value;
      const showContrib = document.getElementById('showContribLine').checked;

      document.getElementById('results').style.display = 'block';
      renderChart(labels, result.seriesNom, result.seriesReal, result.seriesContribNom, view, showContrib);

      // Snapshot
      renderSnapshot(startDate, result);

      // Hook chart controls to re-render quickly
      const chartView = document.getElementById('chartView');
      const showContribLine = document.getElementById('showContribLine');

      chartView.onchange = () => renderChart(labels, result.seriesNom, result.seriesReal, result.seriesContribNom, chartView.value, showContribLine.checked);
      showContribLine.onchange = () => renderChart(labels, result.seriesNom, result.seriesReal, result.seriesContribNom, chartView.value, showContribLine.checked);
    }

    function reset(e){
      e.preventDefault();
      hideMsg();

      document.getElementById('startBalance').value = 5000;
      document.getElementById('startDate').value = toDateInputValue(new Date());
      document.getElementById('years').value = 20;
      document.getElementById('months').value = 0;
      document.getElementById('rateApr').value = 7.00;
      document.getElementById('compoundFreq').value = 'monthly';
      document.getElementById('inflation').value = 2.50;
      document.getElementById('safeWR').value = 4.0;

      document.getElementById('contribAmount').value = 200;
      document.getElementById('contribFreq').value = 'monthly';
      document.getElementById('annualIncrease').value = 0;
      document.getElementById('contribPaused').checked = false;

      // events
      events = [];
      renderEventsTable();
      document.getElementById('eventType').value = 'oneoff_cash';
      document.getElementById('eventDate').value = toDateInputValue(new Date());
      document.getElementById('eventValue').value = 1000;
      helpForEventType('oneoff_cash');

      // results
      document.getElementById('results').style.display = 'none';
      document.getElementById('finalNominal').textContent = '—';
      document.getElementById('finalReal').textContent = '—';
      document.getElementById('endDateKpi').textContent = '—';
      document.getElementById('totalContribNom').textContent = '—';
      document.getElementById('totalContribReal').textContent = '—';
      document.getElementById('totalInterest').textContent = '—';
      document.getElementById('incomeNom').textContent = '—';
      document.getElementById('incomeReal').textContent = '—';
      document.getElementById('netGainReal').textContent = '—';

      document.getElementById('snapTbody').innerHTML = `<tr><td colspan="5" class="muted">Calculate to see snapshot.</td></tr>`;

      document.getElementById('chartView').value = 'both';
      document.getElementById('showContribLine').checked = true;

      if (chart) chart.destroy();
    }

    // ---------------- init wiring ----------------
    document.getElementById('calcBtn').addEventListener('click', calculate);
    document.getElementById('resetBtn').addEventListener('click', reset);

    // dates default
    document.getElementById('startDate').value = toDateInputValue(new Date());
    document.getElementById('eventDate').value = toDateInputValue(new Date());

    // event help
    const eventTypeEl = document.getElementById('eventType');
    eventTypeEl.addEventListener('change', () => helpForEventType(eventTypeEl.value));
    helpForEventType(eventTypeEl.value);

    document.getElementById('addEventBtn').addEventListener('click', (e) => {
      e.preventDefault();
      hideMsg();

      const type = document.getElementById('eventType').value;
      const dateStr = document.getElementById('eventDate').value;
      const value = Number(document.getElementById('eventValue').value);

      if (!dateStr){ showMsg('Please choose an event date.', 'bad'); return; }

      // value rules
      if (type === 'resume_contrib'){
        // ignore value
      } else {
        if (!Number.isFinite(value)){ showMsg('Event value must be a number.', 'bad'); return; }
        if (type === 'rate_change' && value < 0){ showMsg('Rate cannot be negative.', 'bad'); return; }
        if (type === 'pause_contrib' && value < 0){ showMsg('Pause months cannot be negative.', 'bad'); return; }
      }

      const id = String(Date.now()) + Math.random().toString(16).slice(2);
      events.push({
        id,
        type,
        dateStr,
        value: (type === 'resume_contrib') ? 0 : value
      });

      renderEventsTable();
    });

    document.getElementById('clearEventsBtn').addEventListener('click', (e) => {
      e.preventDefault();
      events = [];
      renderEventsTable();
    });
  </script>
</body>
</html>
